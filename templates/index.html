{% extends 'base.html' %}
{% load custom_filters %}
{% load humanize %}
{% load static %}

{% block subnav %}
<!-- Secondary Nav / Filters -->
<div class="border-bottom border-secondary bg-dark py-2 mb-4">
    <div class="container-fluid px-4 d-flex align-items-center gap-3 overflow-auto">
        <button class="btn btn-sm btn-light fw-bold rounded-pill px-3" type="button" data-bs-toggle="offcanvas"
            data-bs-target="#filterSidebar">
            <i class="bi bi-sliders"></i> Filters
        </button>
        <div class="vr text-secondary mx-2"></div>
        <span class="text-nexus-muted small fw-bold text-uppercase">Quick Links:</span>
        <a href="?q=Electronics" class="btn btn-sm btn-link text-white text-decoration-none fw-bold">Electronics</a>
        <a href="?q=Collectibles" class="btn btn-sm btn-link text-nexus-muted text-decoration-none">Collectibles</a>
        <a href="?q=Fashion" class="btn btn-sm btn-link text-nexus-muted text-decoration-none">Fashion</a>

        <!-- Sort Form -->
        <div class="ms-auto">
            <form id="sortForm" method="GET" class="d-flex align-items-center gap-2">
                <!-- Preserve existing filters -->
                {% if request.GET.q %}<input type="hidden" name="q" value="{{ request.GET.q }}">{% endif %}
                {% if request.GET.min_price %}<input type="hidden" name="min_price"
                    value="{{ request.GET.min_price }}">{% endif %}
                {% if request.GET.max_price %}<input type="hidden" name="max_price"
                    value="{{ request.GET.max_price }}">{% endif %}

                <span class="text-nexus-muted small">Sort by:</span>
                <select name="sort" class="form-select form-select-sm bg-dark text-white border-secondary" style="width: auto;" onchange="this.form.submit()">
                    <option value="newest" {% if request.GET.sort == 'newest' or not request.GET.sort %}selected{% endif %}>Newest</option>
                    <option value="urgent" {% if request.GET.sort == 'urgent' %}selected{% endif %}>Most Urgent</option>
                    <option value="price_asc" {% if request.GET.sort == 'price_asc' %}selected{% endif %}>Price: Low to High</option>
                    <option value="price_desc" {% if request.GET.sort == 'price_desc' %}selected{% endif %}>Price: High to Low</option>
                </select>
            </form>
        </div>
    </div>
</div>

<!-- Offcanvas Filter Sidebar -->
<div class="offcanvas-body">
        <form action="{% url 'home' %}" method="GET">
            {% if request.GET.q %}<input type="hidden" name="q" value="{{ request.GET.q }}">{% endif %}

            <div class="mb-4">
                <label class="form-label fw-bold text-uppercase small text-nexus-muted">Price Range</label>
                <div class="input-group input-group-sm mb-2">
                    <span class="input-group-text bg-black border-secondary text-secondary">$</span>
                    <input type="number" name="min_price" class="form-control bg-black border-secondary text-white"
                        placeholder="Min" value="{{ request.GET.min_price }}">
                </div>
                <div class="input-group input-group-sm">
                    <span class="input-group-text bg-black border-secondary text-secondary">$</span>
                    <input type="number" name="max_price" class="form-control bg-black border-secondary text-white"
                        placeholder="Max" value="{{ request.GET.max_price }}">
                </div>
            </div>

            <div class="mb-4">
                <label class="form-label fw-bold text-uppercase small text-nexus-muted">Condition</label>
                <div class="form-check">
                    <input class="form-check-input bg-black border-secondary" type="checkbox" name="condition"
                        value="NEW" id="condNew" {% if 'NEW' in request.GET.condition %}checked{% endif %}>
                    <label class="form-check-label text-white" for="condNew">New</label>
                </div>
                <div class="form-check">
                    <input class="form-check-input bg-black border-secondary" type="checkbox" name="condition"
                        value="USED" id="condUsed" {% if 'USED' in request.GET.condition %}checked{% endif %}>
                    <label class="form-check-label text-white" for="condUsed">Used</label>
                </div>
                <div class="form-check">
                    <input class="form-check-input bg-black border-secondary" type="checkbox" name="condition"
                        value="REFURBISHED" id="condRefurb" {% if 'REFURBISHED' in request.GET.condition %}checked{% endif %}>
                    <label class="form-check-label text-white" for="condRefurb">Refurbished</label>
                </div>
            </div>

            <div class="d-grid gap-2">
                <button type="submit" class="btn btn-nexus-blue fw-bold">Apply Filters</button>
                <a href="{% url 'home' %}" class="btn btn-outline-secondary btn-sm">Clear All</a>
            </div>
        </form>
    </div>
{% endblock %}

{% block content %}
<div class="max-w-[1600px] mx-auto px-4 sm:px-6 lg:px-8 py-6">
    <div class="flex flex-col lg:flex-row gap-6">

        <!-- Sidebar -->
        <aside class="w-full lg:w-64 flex-shrink-0 space-y-6">
            <!-- User Status Panel -->
            {% if user.is_authenticated %}
            <div class="bg-surface-dark border border-border-dark rounded-xl p-5 shadow-lg">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="font-display font-bold text-gray-100 uppercase text-sm tracking-wider">My Status</h3>
                    <span class="material-symbols-outlined text-gray-500 text-lg">equalizer</span>
                </div>
                <div class="space-y-4">
                    <div
                        class="flex items-center justify-between p-2 rounded-lg bg-surface-lighter border-l-2 border-success">
                        <div class="flex flex-col">
                            <span class="text-[10px] text-gray-400 uppercase font-bold">Winning</span>
                            <span class="text-white font-mono font-bold">{{ user_stats.winning|default:"0" }}
                                items</span>
                        </div>
                        <span class="material-symbols-outlined text-success">trending_up</span>
                    </div>
                    <div
                        class="flex items-center justify-between p-2 rounded-lg bg-surface-lighter border-l-2 border-danger">
                        <div class="flex flex-col">
                            <span class="text-[10px] text-gray-400 uppercase font-bold">Outbid</span>
                            <span class="text-white font-mono font-bold">{{ user_stats.outbid|default:"0" }}
                                items</span>
                        </div>
                        <span class="material-symbols-outlined text-danger">trending_down</span>
                    </div>
                </div>
                <a href="{% url 'dashboard' %}"
                    class="block text-center w-full mt-4 py-2 text-xs font-bold text-gray-300 bg-surface-lighter hover:bg-white/10 rounded transition-colors border border-border-dark">
                    VIEW DASHBOARD
                </a>
            </div>
            {% endif %}

            <!-- Category Nav -->
            <div class="bg-surface-dark border border-border-dark rounded-xl p-1 shadow-lg">
                <nav class="space-y-1">
                    <a class="flex items-center gap-3 px-4 py-3 text-sm font-medium rounded-lg transition-all group 
                        {% if not request.GET.category %} bg-surface-lighter text-white border-l-2 border-primary {% else %} text-gray-400 hover:text-white hover:bg-surface-lighter {% endif %}"
                        href="{% url 'catalog' %}">
                        <span class="material-symbols-outlined {% if not request.GET.category %} text-primary {% else %} group-hover:text-secondary {% endif %} text-[20px]">apps</span> 
                        All Categories
                    </a>

                    {% for cat in categories %}
                    <a class="flex items-center gap-3 px-4 py-3 text-sm font-medium rounded-lg transition-all group 
                        {% if request.GET.category == cat.id|stringformat:'i' %} bg-surface-lighter text-white border-l-2 border-primary {% else %} text-gray-400 hover:text-white hover:bg-surface-lighter {% endif %}"
                        href="{% url 'catalog' %}?category={{ cat.id }}">
                        <span class="material-symbols-outlined {% if request.GET.category == cat.id|stringformat:'i' %} text-primary {% else %} group-hover:text-secondary {% endif %} text-[20px]">
                            {% if cat.name == 'Electronics' %}joystick
                            {% elif cat.name == 'Watches' %}watch
                            {% elif cat.name == 'Art' %}palette
                            {% elif cat.name == 'Motors' %}directions_car
                            {% elif cat.name == 'Fashion' %}checkroom
                            {% else %}label{% endif %}
                        </span> 
                        {{ cat.name }}
                    </a>
                    {% endfor %}
                </nav>
            </div>
        </aside>

        <!-- Main Content Area -->
        <main class="flex-1 space-y-8 min-w-0">

            {% if hero_product %}
            <!-- Hero Section -->
            <section class="relative h-[480px] rounded-2xl overflow-hidden border border-border-dark shadow-2xl group">
                <div class="absolute inset-0 bg-surface-dark">
                    {% if hero_product.images.first %}
                    <img alt="{{ hero_product.title }}"
                        class="w-full h-full object-contain opacity-80 scale-90 group-hover:scale-100 transition-transform duration-700 ease-out p-12 lg:translate-x-32"
                        src="{{ hero_product.images.first.image.url }}" />
                    {% endif %}
                    <div class="absolute inset-0 bg-gradient-to-r from-surface-dark via-surface-dark/80 to-transparent">
                    </div>
                    <div class="absolute inset-0 bg-gradient-to-t from-surface-dark via-transparent to-transparent">
                    </div>
                </div>
                <div class="absolute top-8 right-8 flex gap-2">
                    <span
                        class="px-3 py-1 rounded bg-black/40 backdrop-blur border border-white/10 text-xs text-white flex items-center gap-2">
                        <span class="w-2 h-2 rounded-full bg-primary animate-pulse"></span> 34 WATCHING
                    </span>
                </div>
                <div class="absolute bottom-0 left-0 p-8 lg:p-12 w-full lg:w-2/3 z-10">
                    <div class="mb-4">
                        <span
                            class="inline-block px-2 py-0.5 rounded text-[10px] font-bold tracking-widest uppercase bg-primary text-white mb-2">Ending
                            Soon</span>
                        <h1 class="text-4xl lg:text-6xl font-display font-bold text-white leading-tight mb-2">
                            {{hero_product.title }}</h1>
                    </div>
                    {% if hero_product.sales_type != 'DIRECT' %}
                    <div class="flex flex-col sm:flex-row sm:items-end gap-8 mb-8">
                        <div>
                            <p class="text-gray-400 text-xs font-mono uppercase tracking-widest mb-1">Time Remaining</p>
                            <div class="font-mono text-5xl lg:text-6xl font-bold text-primary neon-text-orange tracking-tighter auction-timer"
                                data-end-time="{{ hero_product.auction_end_time|date:'c' }}">
                                {{ hero_product.auction_end_time|precise_time_left }}
                            </div>
                        </div>
                        <div class="h-12 w-[1px] bg-gray-700 hidden sm:block"></div>
                        <div>
                            <p class="text-gray-400 text-xs font-mono uppercase tracking-widest mb-1">Current Bid</p>
                            <p class="text-3xl font-display font-bold text-white">${{ hero_product.current_highest_bid|default:hero_product.initial_price|floatformat:2|intcomma }}</p>
                        </div>
                    </div>
                    {% else %}
                    <div class="mb-8">
                        <p class="text-4xl font-display font-bold text-secondary neon-text-blue">${{ hero_product.initial_price|floatformat:2|intcomma }}</p>
                    </div>
                    {% endif %}
                    <div class="flex gap-4">
                        <a href="{% url 'product_detail' hero_product.id %}"
                            class="bg-primary hover:bg-orange-600 text-white font-bold py-3 px-8 rounded-xl shadow-lg shadow-orange-900/40 transform transition-all hover:translate-y-[-2px] flex items-center gap-2">
                            {% if hero_product.sales_type == 'DIRECT' %} BUY NOW {% else %} PLACE BID {% endif %} <span
                                class="material-symbols-outlined">arrow_forward</span>
                        </a>
                    </div>
                </div>
            </section>
            {% endif %}

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <!-- Hot Auctions Column -->
                <div class="space-y-6">
                    <div class="flex items-center justify-between border-b border-white/10 pb-4">
                        <div class="flex items-center gap-3">
                            <span class="material-symbols-outlined text-primary text-3xl">local_fire_department</span>
                            <h2 class="text-2xl font-display font-bold text-white">Hot Auctions</h2>
                        </div>
                    </div>

                    {% for product in hot_auctions %}
                    <div
                        class="group relative bg-surface-dark border border-border-dark rounded-xl p-4 hover:border-primary/50 transition-all duration-300">
                        <div class="absolute top-4 right-4 z-10">
                            {% if product.auction_end_time|is_expired %}
                            <span class="bg-red-500 text-white text-[10px] font-bold px-2 py-1 rounded">ENDED</span>
                            {% else %}
                            <span
                                class="flex items-center gap-1 bg-black/60 backdrop-blur px-2 py-1 rounded text-[10px] text-white border border-white/10">
                                <span class="w-1.5 h-1.5 rounded-full bg-danger animate-pulse"></span> {{
                                product.auction_end_time|precise_time_left }}
                            </span>
                            {% endif %}
                        </div>
                        <div class="flex gap-4">
                            <div class="w-32 h-32 flex-shrink-0 bg-surface-lighter rounded-lg overflow-hidden p-2">
                                {% if product.images.first %}
                                <img src="{{ product.images.first.image.url }}"
                                    class="w-full h-full object-contain group-hover:scale-110 transition-transform duration-500">
                                {% endif %}
                            </div>
                            <div class="flex-1 flex flex-col justify-between">
                                <div>
                                    <h3
                                        class="font-bold text-white text-lg leading-tight mb-1 group-hover:text-primary transition-colors">
                                        <a href="{% url 'product_detail' product.id %}">{{ product.title|truncatechars:30 }}</a>
                                    </h3>
                                    <p class="text-xs text-gray-400 mb-3">{{ product.category.name|default:"General" }}
                                    </p>
                                </div>
                                <div class="flex items-end justify-between">
                                    <div>
                                        <p class="text-[10px] text-gray-500 uppercase font-bold">Current Bid</p>
                                        <p class="text-xl font-mono font-bold text-primary">
                                            ${{ product.current_highest_bid|default:product.initial_price|floatformat:2 }}
                                        </p>
                                    </div>
                                    <div class="text-right">
                                        <a href="{% url 'product_detail' product.id %}"
                                            class="px-4 py-1.5 bg-primary/10 hover:bg-primary text-primary hover:text-white border border-primary/50 rounded text-xs font-bold transition-all uppercase block">
                                            Bid Now
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>

                <!-- New Arrivals Column -->
                <div class="space-y-6">
                    <div class="flex items-center justify-between border-b border-white/10 pb-4">
                        <div class="flex items-center gap-3">
                            <span class="material-symbols-outlined text-secondary text-3xl">bolt</span>
                            <h2 class="text-2xl font-display font-bold text-white">New Arrivals</h2>
                        </div>
                        <a class="text-xs font-bold text-gray-500 hover:text-white transition-colors uppercase tracking-widest"
                            href="?sort=newest">Shop All</a>
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        {% for product in new_arrivals %}
                        <a href="{% url 'product_detail' product.id %}" 
                           class="block bg-surface-dark border border-border-dark rounded-xl p-3 hover:border-secondary/50 transition-colors group relative">
                            {% if product.condition == 'NEW' %}
                            <span class="absolute top-2 left-2 bg-secondary text-black text-[8px] font-bold px-1 rounded z-10">NEW</span>
                            {% endif %}
                            <div class="aspect-square bg-surface-lighter rounded-lg mb-3 overflow-hidden p-2">
                                {% if product.images.first %}
                                <img src="{{ product.images.first.image.url }}"
                                    class="w-full h-full object-contain opacity-80 group-hover:opacity-100 transition-opacity">
                                {% endif %}
                            </div>
                            <h4 class="font-semibold text-white text-sm truncate mb-1">{{ product.title }}</h4>
                            <div class="flex justify-between items-center">
                                <span class="text-secondary font-bold text-sm">${{ product.initial_price|floatformat:2 }}</span>
                                <div class="w-6 h-6 rounded bg-surface-lighter hover:bg-secondary hover:text-black flex items-center justify-center text-gray-400 transition-colors">
                                    <span class="material-symbols-outlined text-[16px]">add</span>
                                </div>
                            </div>
                        </a>
                        {% endfor %}
                    </div>
                    </div>
                </div>
            </div> <!-- Close grid-cols-2 -->

            <!-- Featured Gift Cards Section (New) -->
            {% if featured_gift_cards %}
            <div class="col-span-full mt-8 pt-8 border-t border-white/10">
                    <div class="flex items-center justify-between mb-6">
                        <div class="flex items-center gap-3">
                            <span class="material-symbols-outlined text-green-500 text-3xl">card_giftcard</span>
                            <h2 class="text-2xl font-display font-bold text-white">Digital Gift Cards</h2>
                        </div>
                        <a class="text-xs font-bold text-gray-500 hover:text-white transition-colors uppercase tracking-widest"
                            href="{% url 'gift_cards' %}">View All</a>
                    </div>
                    <div class="grid grid-cols-2 lg:grid-cols-4 gap-4">
                        {% for card in featured_gift_cards %}
                        <a href="{% url 'product_detail' card.id %}" class="block bg-surface-dark border border-border-dark rounded-xl p-4 hover:border-green-500/50 transition-colors group relative">
                            <div class="aspect-video bg-gradient-to-br from-gray-800 to-black rounded-lg mb-3 overflow-hidden flex items-center justify-center relative">
                                {% if card.images.first %}
                                <img src="{{ card.images.first.image.url }}" class="w-full h-full object-cover opacity-80 group-hover:opacity-100 transition-opacity">
                                {% else %}
                                <span class="material-symbols-outlined text-4xl text-gray-600">redeem</span>
                                {% endif %}
                                <div class="absolute bottom-2 right-2 bg-black/60 backdrop-blur px-2 py-0.5 rounded text-[10px] text-green-400 font-bold border border-green-500/20">INSTANT</div>
                            </div>
                            <h4 class="font-semibold text-white text-sm truncate mb-1">{{ card.title }}</h4>
                            <p class="text-xs text-gray-400 font-mono">Variable Amount</p>
                        </a>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}
<script src="{% static 'js/countdown.js' %}"></script>
{% endblock %}